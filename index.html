<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>姓名填寫（三格）</title>
  <style>
    body{font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto; margin:0; background:#f6f7f9;}
    .wrap{max-width:560px; margin:24px auto; padding:16px;}
    h2{font-size:20px; margin:0 0 12px;}
    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin:12px 0 16px;}
    label{font-size:14px; color:#333; display:block;}
    input{width:100%; padding:12px; border:1px solid #ddd; border-radius:12px; font-size:16px; background:#fff;}
    .hint{font-size:12px; color:#666; line-height:1.6;}
    button{width:100%; padding:14px; border:0; border-radius:12px; background:#06c755; color:#fff; font-size:16px;}
    .msg{margin-top:12px; font-size:14px; min-height:1.6em;}
    /* 送出後的視覺鎖定 */
    button[disabled]{opacity:.6; filter:grayscale(1); cursor:not-allowed;}
    input[disabled]{background:#eee;}
  </style>
</head>
<body>
  <main class="wrap">
    <h2>請輸入姓名</h2>
    <div class="hint">姓與名為必填；中間字可留空。請以中文輸入。</div>

    <form id="f">
      <div class="grid">
        <label>姓
          <input id="lastname" maxlength="2" autocomplete="off" placeholder="例：林" required />
        </label>
        <label>中間字（選填）
          <input id="middlename" maxlength="2" autocomplete="off" placeholder="例：建" />
        </label>
        <label>名
          <input id="firstname" maxlength="2" autocomplete="off" placeholder="例：宏" required />
        </label>
      </div>
      <button id="submitBtn" type="submit">送出</button>
      <div id="msg" class="msg"></div>
    </form>
  </main>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // ====== 設定 ======
    const LIFF_ID = "2007967250-VZ15Ew5a";     // 你提供的 LIFF ID
    const N8N_WEBHOOK = "https://xin03.zeabur.app/webhook/gosubar";
    // ===================

    const $ = id => document.getElementById(id);
    const show = t => { $("msg").textContent = t; };
    const onlyCJK = s => /^[\u4e00-\u9fff]+$/.test(s);
    const qs = k => new URL(location.href).searchParams.get(k) || "";

    // 防重複提交（前端）
    const SUBMIT_FLAG_KEY = "name_form_submitted";
    let liffReady = false, lineProfile = null, lineContext = null, submitting = false;

    function lockForm(txt="送出中…"){
      submitting = true;
      $("submitBtn").disabled = true;
      $("submitBtn").textContent = txt;
      document.querySelectorAll("input").forEach(i => i.disabled = true);
    }
    function unlockForm(){
      submitting = false;
      $("submitBtn").disabled = false;
      $("submitBtn").textContent = "送出";
      document.querySelectorAll("input").forEach(i => i.disabled = false);
    }
    function finishAndExit(){
      localStorage.setItem(SUBMIT_FLAG_KEY, "1");
      show("已送出，感謝！");
      setTimeout(() => {
        if (liffReady && liff.isInClient()) liff.closeWindow();
        else location.replace(location.pathname + "?sent=1"); // 外部瀏覽器 → 成功狀態
      }, 900);
    }

    async function tryInitLIFF(){
      try{
        if (!/^\d{6,}-/.test(LIFF_ID)) throw new Error("Not a LIFF ID");
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) await liff.login();
        lineProfile = await liff.getProfile().catch(() => null);
        lineContext = liff.getContext ? liff.getContext() : null;
        liffReady = true;
      }catch(e){
        console.warn("[LIFF] init skipped:", e.message || e);
        liffReady = false; // 降級為純網頁模式
      }
    }

    (async () => {
      await tryInitLIFF();

      // 若已送出或帶 ?sent=1 → 直接鎖住畫面，避免再次提交
      if (localStorage.getItem(SUBMIT_FLAG_KEY) === "1" || qs("sent") === "1") {
        lockForm("已送出");
        show("已送出，請關閉此頁。");
      }

      $("f").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (submitting) return; // 防重複點擊

        const ln = $("lastname").value.trim();
        const mn = $("middlename").value.trim();
        const fn = $("firstname").value.trim();

        if (!ln || !fn) return show("姓與名為必填");
        if (!(onlyCJK(ln) && onlyCJK(fn) && (!mn || onlyCJK(mn)))) {
          return show("請以中文輸入，勿含空白或符號");
        }

        lockForm();

        // 產生一次性 nonce（後端可用來去重）
        const nonce = `${Date.now()}-${Math.random().toString(36).slice(2,10)}`;

        const payload = {
          act: "name_submit",
          mode: qs("mode") || "",
          lastname: ln,
          middlename: mn,
          firstname: fn,
          fullName: ln + mn + fn,
          source: liffReady ? "liff" : "web",
          lineUserId: liffReady && lineProfile ? lineProfile.userId : "",
          context: liffReady && lineContext ? lineContext : null,
          nonce,                               // ★ 去重用 token
          ts: Date.now()
        };

        try{
          const res = await fetch(N8N_WEBHOOK, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error("HTTP " + res.status);
          finishAndExit();
        }catch(err){
          console.error(err);
          show("送出失敗，請檢查網路後再試。");
          unlockForm(); // 失敗才解鎖，允許重試
        }
      });
    })();
  </script>
</body>
</html>
