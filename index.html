<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>姓名填寫（三格）</title>
  <style>
    body{font-family:system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto; margin:0; background:#f6f7f9;}
    .wrap{max-width:560px; margin:24px auto; padding:16px;}
    h2{font-size:20px; margin:0 0 12px;}
    .grid{display:flex; flex-direction: column; gap:12px; margin:12px 0 16px;}
    label{font-size:14px; color:#333; display:block;}
    input{width:100%; padding:12px; border:1px solid #ddd; border-radius:12px; font-size:16px; background:#fff;}
    .hint{font-size:12px; color:#666; line-height:1.6;}
    button{width:100%; padding:14px; border:0; border-radius:12px; background:#06c755; color:#fff; font-size:16px;}
    .msg{margin-top:12px; font-size:14px; min-height:1.6em;}
    /* 送出中的視覺鎖定（僅當次） */
    button[disabled]{opacity:.6; filter:grayscale(1); cursor:not-allowed;}
    input[disabled]{background:#eee;}

    /* NEW: 下方等待區塊 */
    .pending{           /* 最外層盒子 */
      margin-top:16px;
      padding:16px;
      border-radius:12px;
      background:#fff;
      border:1px solid #e6e6e6;
      min-height:64px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .pending[hidden]{ display:none; }
    .spin{             /* 小圓圈 spinner */
      width:22px; height:22px;
      border-radius:50%;
      border:3px solid #e5e5e5;
      border-top-color:#06c755;
      animation:spin 0.9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .pending-text{font-size:14px; color:#333; line-height:1.6;}
    .pending-sub{font-size:12px; color:#666;}

    /* 使用者若偏好減少動態，關閉旋轉 */
    @media (prefers-reduced-motion: reduce){
      .spin{animation:none}
    }
  </style>
</head>
<body>
  <main class="wrap">
    <h2>請輸入姓名</h2>
    <div class="hint">姓與名為必填；中間字可留空。請以中文輸入。</div>

    <form id="f">
      <div class="grid">
        <label>姓
          <input id="lastname" maxlength="2" autocomplete="off" placeholder="例：林" required />
        </label>
        <label>中間字（選填）
          <input id="middlename" maxlength="2" autocomplete="off" placeholder="例：建" />
        </label>
        <label>名
          <input id="firstname" maxlength="2" autocomplete="off" placeholder="例：宏" required />
        </label>
      </div>
      <button id="submitBtn" type="submit">送出</button>
      <div id="msg" class="msg"></div>
    </form>

    <!-- NEW: 底部處理中文字區（預設隱藏） -->
    <section id="pending" class="pending" hidden aria-live="polite">
      <div class="spin" aria-hidden="true"></div>
      <div>
        <div class="pending-text" id="pendingMain">正在處理中，請稍候…</div>
        <div class="pending-sub" id="pendingSub">大約需要 10–20 秒，請勿關閉此視窗或離開此頁面。</div>
      </div>
    </section>
  </main>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // ====== 設定 ======
    const LIFF_ID = "2007967250-VZ15Ew5a";
    const N8N_WEBHOOK = "https://xin03.zeabur.app/webhook/gosubar";
    // ===================

    const $ = id => document.getElementById(id);
    const show = t => { $("msg").textContent = t; };
    const onlyCJK = s => /^[\u4e00-\u9fff]+$/.test(s);

    let liffReady = false, lineProfile = null, lineContext = null, submitting = false;

    /* NEW: 控制等待區顯示/隱藏 */
    function setPending(on = true, main = "正在處理中，請稍候…", sub = "大約需要 10–20 秒，請勿關閉此視窗或離開此頁面。"){
      const box = $("pending");
      $("pendingMain").textContent = main;
      $("pendingSub").textContent = sub;
      box.hidden = !on;
    }

    function lockForm(txt="送出中…"){
      submitting = true;
      $("submitBtn").disabled = true;
      $("submitBtn").textContent = txt;
      document.querySelectorAll("input").forEach(i => i.disabled = true);
      setPending(true);           // NEW: 顯示等待區
    }
    function unlockForm(){
      submitting = false;
      $("submitBtn").disabled = false;
      $("submitBtn").textContent = "送出";
      document.querySelectorAll("input").forEach(i => i.disabled = false);
      setPending(false);          // NEW: 隱藏等待區
    }
    function resetForm(){
      $("f").reset();
    }
    function finishAndExit(){
      show("已送出，感謝！");
      setPending(false);          // NEW: 完成即隱藏
      setTimeout(() => {
        if (liffReady && liff.isInClient()) {
          liff.closeWindow();
        } else {
          resetForm();
          unlockForm();
          show("已送出，歡迎再次填寫。");
        }
      }, 900);
    }

    async function tryInitLIFF(){
      try{
        if (!/^\d{6,}-/.test(LIFF_ID)) throw new Error("Not a LIFF ID");
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) await liff.login();
        lineProfile = await liff.getProfile().catch(() => null);
        lineContext = liff.getContext ? liff.getContext() : null;
        liffReady = true;
      }catch(e){
        console.warn("[LIFF] init skipped:", e.message || e);
        liffReady = false; // 降級為純網頁模式
      }
    }

    (async () => {
      await tryInitLIFF();

      $("f").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (submitting) return; // 防重複點擊

        const ln = $("lastname").value.trim();
        const mn = $("middlename").value.trim();
        const fn = $("firstname").value.trim();

        if (!ln || !fn) return show("姓與名為必填");
        if (!(onlyCJK(ln) && onlyCJK(fn) && (!mn || onlyCJK(mn)))) {
          return show("請以中文輸入，勿含空白或符號");
        }

        lockForm();

        const nonce = `${Date.now()}-${Math.random().toString(36).slice(2,10)}`;

        const payload = {
          act: "name_submit",
          mode: new URL(location.href).searchParams.get("mode") || "",
          lastname: ln,
          middlename: mn,
          firstname: fn,
          fullName: ln + mn + fn,
          source: liffReady ? "liff" : "web",
          lineUserId: liffReady && lineProfile ? lineProfile.userId : "",
          context: liffReady && lineContext ? lineContext : null,
          nonce,
          ts: Date.now()
        };

        try{
          const res = await fetch(N8N_WEBHOOK, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error("HTTP " + res.status);
          finishAndExit();
        }catch(err){
          console.error(err);
          show("送出失敗，請檢查網路後再試。");
          unlockForm(); // 失敗才解鎖，允許重試
        }
      });
    })();
  </script>
</body>
</html>
